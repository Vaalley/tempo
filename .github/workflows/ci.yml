name: Tempo CI Pipeline

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    # JOB 1: Code Quality & Logic
    quality:
        name: üõ°Ô∏è Quality & Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install Dependencies
              run: bun install --frozen-lockfile

            - name: Check Formatting (Oxfmt)
              run: bun run format:check

            - name: Lint Code (Oxlint)
              run: bun run lint

            - name: Run Unit Tests (Vitest)
              run: bun run test

    # JOB 2: Build Verification
    docker-build:
        name: üê≥ Docker Build Check
        needs: quality # Only runs if Quality passes
        runs-on: ubuntu-latest

        services:
            # We spin up a fake registry to test "pushing" without actually pushing to DockerHub
            registry:
                image: registry:2
                ports:
                    - 5000:5000

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
              with:
                  driver-opts: network=host

            # Build Backend Image
            - name: Build Backend Container
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: apps/backend/Dockerfile
                  push: false # We just want to verify it builds
                  tags: localhost:5000/tempo-backend:latest

            # Build Frontend Image
            - name: Build Frontend Container
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: apps/frontend/Dockerfile
                  push: false
                  tags: localhost:5000/tempo-frontend:latest
